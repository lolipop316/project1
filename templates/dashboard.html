<!DOCTYPE html>
<html>
<head>
    <title>Dashboard - Personal Finance App</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f6f8; margin:0; padding:0;}
        .container { max-width: 1200px; margin: 30px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1);}
        h1, h2, h3 { text-align: center; }
        a { text-decoration: none; margin-right: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
        th { background-color: #f2f2f2; cursor: pointer; }
        .flash { padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; }
        .danger { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #cce5ff; color: #004085; }
        .action-btn { padding: 5px 10px; margin-right: 5px; font-size: 0.9em; }
        .edit-btn { background-color: #2196F3; color: white; border: none; border-radius: 3px; cursor: pointer; }
        .edit-btn:hover { background-color: #1976D2; }
        .delete-btn { background-color: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer; }
        .delete-btn:hover { background-color: #d32f2f; }
        form input, form select, form button { padding: 5px; margin-right: 5px; margin-top:5px; }
        .charts { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 30px; justify-content: space-around; }
        canvas { background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
        .totals { display: flex; justify-content: space-around; margin-top: 20px; font-weight: bold; }
        .export-btn { margin-top: 10px; padding: 8px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .export-btn:hover { background-color: #388E3C; }
        .overspend { color: red; font-weight: bold; }
        @media(max-width:1000px) { .charts { flex-direction: column; align-items: center; } }
    </style>
</head>
<body>
<div class="container">
    <h1>Welcome, {{ current_user.username }}</h1>
    <div>
        <a href="{{ url_for('home') }}">Home</a> |
        <a href="{{ url_for('logout') }}">Logout</a> |
        <a href="{{ url_for('export_csv') }}"><button class="export-btn">Export CSV</button></a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="flash {{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Totals and Balance -->
    <div class="totals">
        <div>Total Income: ${{ "%.2f"|format(total_income) }}</div>
        <div>Total Expenses: ${{ "%.2f"|format(total_expenses) }}</div>
        <div>Balance: ${{ "%.2f"|format(balance) }}</div>
    </div>

    <!-- Add Expense Form -->
    <h2>Add Expense</h2>
    <form method="POST" action="{{ url_for('dashboard') }}">
        <input type="text" name="description" placeholder="Description" required>
        <input type="number" step="0.01" name="amount" placeholder="Amount" required>
        <select name="category" required>
            <option value="Food">Food</option>
            <option value="Transport">Transport</option>
            <option value="Entertainment">Entertainment</option>
            <option value="Bills">Bills</option>
            <option value="Other" selected>Other</option>
        </select>
        <input type="text" name="notes" placeholder="Notes (optional)">
        <button type="submit" name="expense_submit">Add Expense</button>
    </form>

    <!-- Add Recurring Expense Form -->
    <h2>Add Recurring Expense</h2>
    <form method="POST" action="{{ url_for('add_recurring_expense') }}">
        <input type="text" name="description" placeholder="Description" required>
        <input type="number" step="0.01" name="amount" placeholder="Amount" required>
        <select name="category" required>
            <option value="Food">Food</option>
            <option value="Transport">Transport</option>
            <option value="Entertainment">Entertainment</option>
            <option value="Bills">Bills</option>
            <option value="Other" selected>Other</option>
        </select>
        <input type="number" name="frequency_days" placeholder="Frequency (days)" required>
        <button type="submit" name="recurring_submit">Add Recurring</button>
    </form>

    <!-- Budgets Form -->
    <h2>Set Monthly Budget</h2>
    <form method="POST" action="{{ url_for('set_budget') }}">
        <select name="category" required>
            <option value="Food">Food</option>
            <option value="Transport">Transport</option>
            <option value="Entertainment">Entertainment</option>
            <option value="Bills">Bills</option>
            <option value="Other" selected>Other</option>
        </select>
        <input type="number" step="0.01" name="amount" placeholder="Budget Amount" required>
        <button type="submit">Set Budget</button>
    </form>

    <!-- Expenses Table -->
    <h2>Expenses</h2>
    {% if expenses %}
    <table>
        <tr><th>Date</th><th>Description</th><th>Amount</th><th>Category</th><th>Notes</th><th>Actions</th></tr>
        {% for exp in expenses %}
        <tr>
            <td>{{ exp.date.strftime("%Y-%m-%d") }}</td>
            <td>{{ exp.description }}</td>
            <td {% if budgets[exp.category] and exp.amount > budgets[exp.category] %} class="overspend" {% endif %}>
                {{ "%.2f"|format(exp.amount) }}
            </td>
            <td>{{ exp.category }}</td>
            <td>{{ exp.notes }}</td>
            <td>
                <a href="{{ url_for('edit_expense', expense_id=exp.id) }}" class="action-btn edit-btn">Edit</a>
                <form action="{{ url_for('delete_expense', expense_id=exp.id) }}" method="POST" style="display:inline;">
                    <button type="submit" class="action-btn delete-btn">Delete</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </table>
    {% else %}
        <p>No expenses yet.</p>
    {% endif %}

    <!-- Charts -->
    <div class="charts">
        <div style="flex:1 1 300px;">
            <h3>Expenses by Category</h3>
            <canvas id="categoryChart"></canvas>
        </div>
        <div style="flex:1 1 300px;">
            <h3>Expenses vs Budget</h3>
            <canvas id="budgetChart"></canvas>
        </div>
        <div style="flex:1 1 300px;">
            <h3>Income vs Expenses Over Time</h3>
            <canvas id="lineChart"></canvas>
        </div>
    </div>

    <script>
        // Pie chart - Expenses by Category
        new Chart(document.getElementById('categoryChart').getContext('2d'), {
            type:'pie',
            data: {
                labels: {{ chart_labels|tojson }},
                datasets:[{
                    data: {{ chart_values|tojson }},
                    backgroundColor: ['rgba(255,99,132,0.6)','rgba(54,162,235,0.6)','rgba(255,206,86,0.6)','rgba(75,192,192,0.6)','rgba(153,102,255,0.6)']
                }]
            }
        });

        // Bar chart - Expenses vs Budget
        new Chart(document.getElementById('budgetChart').getContext('2d'), {
            type:'bar',
            data: {
                labels: {{ budget_labels|tojson }},
                datasets:[
                    { label:'Expenses', data: {{ budget_exp_values|tojson }}, backgroundColor:'rgba(255,99,132,0.6)' },
                    { label:'Budget', data: {{ budget_values|tojson }}, backgroundColor:'rgba(54,162,235,0.6)' }
                ]
            },
            options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
        });

        // Line chart - Income vs Expenses
        new Chart(document.getElementById('lineChart').getContext('2d'), {
            type:'line',
            data:{
                labels: {{ line_labels|tojson }},
                datasets:[
                    { label:'Expenses', data: {{ line_exp|tojson }}, borderColor:'rgba(255,99,132,1)', backgroundColor:'rgba(255,99,132,0.2)', fill:true },
                    { label:'Income', data: {{ line_inc|tojson }}, borderColor:'rgba(54,162,235,1)', backgroundColor:'rgba(54,162,235,0.2)', fill:true }
                ]
            },
            options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
        });
    </script>
</div>
</body>
</html>
